#include "inprocess_filedialog.h"
#include <algorithm>
#include <cstring>
#include <dirent.h>
#include <sys/stat.h>

// 8x16 CP437 bitmap font data for ASCII 32-127 (96 characters)
// Each character is 16 bytes (8 pixels wide, 16 rows, 1 bit per pixel, MSB left)
static const unsigned char fontData[96][16]=
{
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 32 ' '
	{0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00}, // 33 '!'
	{0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 34 '"'
	{0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00}, // 35 '#'
	{0x18,0x18,0x7C,0xC6,0xC2,0xC0,0x7C,0x06,0x06,0x86,0xC6,0x7C,0x18,0x18,0x00,0x00}, // 36 '$'
	{0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00}, // 37 '%'
	{0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00}, // 38 '&'
	{0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 39 '''
	{0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00}, // 40 '('
	{0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00}, // 41 ')'
	{0x00,0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00}, // 42 '*'
	{0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00}, // 43 '+'
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00}, // 44 ','
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 45 '-'
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00}, // 46 '.'
	{0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00}, // 47 '/'
	{0x00,0x00,0x7C,0xC6,0xC6,0xCE,0xDE,0xF6,0xE6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 48 '0'
	{0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00}, // 49 '1'
	{0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00}, // 50 '2'
	{0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 51 '3'
	{0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00}, // 52 '4'
	{0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 53 '5'
	{0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 54 '6'
	{0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00}, // 55 '7'
	{0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 56 '8'
	{0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00}, // 57 '9'
	{0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00}, // 58 ':'
	{0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00}, // 59 ';'
	{0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00}, // 60 '<'
	{0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 61 '='
	{0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00}, // 62 '>'
	{0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00}, // 63 '?'
	{0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0xC0,0x7C,0x00,0x00,0x00,0x00}, // 64 '@'
	{0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00}, // 65 'A'
	{0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00}, // 66 'B'
	{0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00}, // 67 'C'
	{0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00}, // 68 'D'
	{0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00}, // 69 'E'
	{0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00}, // 70 'F'
	{0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00}, // 71 'G'
	{0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00}, // 72 'H'
	{0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00}, // 73 'I'
	{0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00}, // 74 'J'
	{0x00,0x00,0xE6,0x66,0x66,0x6C,0x78,0x78,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00}, // 75 'K'
	{0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00}, // 76 'L'
	{0x00,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00}, // 77 'M'
	{0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00}, // 78 'N'
	{0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 79 'O'
	{0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00}, // 80 'P'
	{0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00}, // 81 'Q'
	{0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00}, // 82 'R'
	{0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 83 'S'
	{0x00,0x00,0x7E,0x7E,0x5A,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00}, // 84 'T'
	{0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 85 'U'
	{0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00}, // 86 'V'
	{0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0xEE,0x6C,0x00,0x00,0x00,0x00}, // 87 'W'
	{0x00,0x00,0xC6,0xC6,0x6C,0x7C,0x38,0x38,0x7C,0x6C,0xC6,0xC6,0x00,0x00,0x00,0x00}, // 88 'X'
	{0x00,0x00,0x66,0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00}, // 89 'Y'
	{0x00,0x00,0xFE,0xC6,0x86,0x0C,0x18,0x30,0x60,0xC2,0xC6,0xFE,0x00,0x00,0x00,0x00}, // 90 'Z'
	{0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00}, // 91 '['
	{0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x06,0x02,0x00,0x00,0x00,0x00}, // 92 '\'
	{0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00}, // 93 ']'
	{0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 94 '^'
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00}, // 95 '_'
	{0x00,0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 96 '`'
	{0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00}, // 97 'a'
	{0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00}, // 98 'b'
	{0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 99 'c'
	{0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00}, // 100 'd'
	{0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 101 'e'
	{0x00,0x00,0x1C,0x36,0x32,0x30,0x78,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00}, // 102 'f'
	{0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00}, // 103 'g'
	{0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00}, // 104 'h'
	{0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00}, // 105 'i'
	{0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00}, // 106 'j'
	{0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00}, // 107 'k'
	{0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00}, // 108 'l'
	{0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0xD6,0xC6,0x00,0x00,0x00,0x00}, // 109 'm'
	{0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00}, // 110 'n'
	{0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 111 'o'
	{0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00}, // 112 'p'
	{0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00}, // 113 'q'
	{0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00}, // 114 'r'
	{0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00}, // 115 's'
	{0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00}, // 116 't'
	{0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00}, // 117 'u'
	{0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x00,0x00,0x00,0x00}, // 118 'v'
	{0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0x6C,0x00,0x00,0x00,0x00}, // 119 'w'
	{0x00,0x00,0x00,0x00,0x00,0xC6,0x6C,0x38,0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00}, // 120 'x'
	{0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00}, // 121 'y'
	{0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00}, // 122 'z'
	{0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00}, // 123 '{'
	{0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00}, // 124 '|'
	{0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00}, // 125 '}'
	{0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 126 '~'
	{0x00,0x00,0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xC6,0xFE,0x00,0x00,0x00,0x00,0x00}, // 127 DEL
};

// Font texture atlas: 16 chars per row, 6 rows = 128x96 pixels
static const int ATLAS_COLS=16;
static const int ATLAS_ROWS=6;
static const int ATLAS_W=ATLAS_COLS*8;   // 128
static const int ATLAS_H=ATLAS_ROWS*16;  // 96

void InProcessFileDialog::InitFont(void)
{
	if(fontInitialized)
	{
		return;
	}

	// Build RGBA texture atlas
	unsigned char atlas[ATLAS_W*ATLAS_H*4];
	memset(atlas,0,sizeof(atlas));

	for(int ch=0;ch<96;++ch)
	{
		int col=ch%ATLAS_COLS;
		int row=ch/ATLAS_COLS;
		for(int y=0;y<16;++y)
		{
			unsigned char bits=fontData[ch][y];
			for(int x=0;x<8;++x)
			{
				int px=(col*8+x);
				int py=(row*16+y);
				int idx=(py*ATLAS_W+px)*4;
				if(bits&(0x80>>x))
				{
					atlas[idx+0]=255;
					atlas[idx+1]=255;
					atlas[idx+2]=255;
					atlas[idx+3]=255;
				}
				else
				{
					atlas[idx+0]=0;
					atlas[idx+1]=0;
					atlas[idx+2]=0;
					atlas[idx+3]=0;
				}
			}
		}
	}

	glGenTextures(1,&fontTexId);
	glBindTexture(GL_TEXTURE_2D,fontTexId);
	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_WRAP_S,GL_CLAMP);
	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_WRAP_T,GL_CLAMP);
	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MIN_FILTER,GL_NEAREST);
	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,GL_NEAREST);
	glTexImage2D(GL_TEXTURE_2D,0,GL_RGBA,ATLAS_W,ATLAS_H,0,GL_RGBA,GL_UNSIGNED_BYTE,atlas);

	fontInitialized=true;
}

void InProcessFileDialog::Open(int dt)
{
	driveType=dt;
	selectedIndex=0;
	scrollOffset=0;
	selectedPath.clear();
	currentDir=GetBaseDir();
	RefreshFileList();
	active=true;
	InitFont();
}

void InProcessFileDialog::Close(void)
{
	active=false;
}

std::string InProcessFileDialog::GetBaseDir(void) const
{
	switch(driveType)
	{
	case 0: return "/Users/higem/Projects/towns/cdd/";
	case 1: return "/Users/higem/Projects/towns/fdd/";
	case 2: return "/Users/higem/Projects/towns/fdd/";
	}
	return "/";
}

std::string InProcessFileDialog::GetSelectedPath(void) const
{
	return selectedPath;
}

static std::string ToLower(const std::string &s)
{
	std::string r=s;
	for(auto &c : r)
	{
		if('A'<=c && c<='Z') c+=32;
	}
	return r;
}

bool InProcessFileDialog::MatchesExtension(const std::string &name) const
{
	auto dot=name.rfind('.');
	if(dot==std::string::npos)
	{
		return false;
	}
	std::string ext=ToLower(name.substr(dot));

	if(driveType==0)
	{
		return ext==".cue"||ext==".iso"||ext==".mds"||ext==".ccd";
	}
	else
	{
		return ext==".bin"||ext==".d77"||ext==".rdd"||ext==".d88"||ext==".xdf";
	}
}

void InProcessFileDialog::RefreshFileList(void)
{
	entries.clear();

	// Always add parent directory
	Entry parent;
	parent.name="..";
	parent.isDir=true;
	entries.push_back(parent);

	DIR *dir=opendir(currentDir.c_str());
	if(dir==nullptr)
	{
		return;
	}

	std::vector<Entry> dirs,files;
	struct dirent *ent;
	while((ent=readdir(dir))!=nullptr)
	{
		std::string name=ent->d_name;
		if(name=="."||name=="..")
		{
			continue;
		}
		if(name.size()>0 && name[0]=='.')
		{
			continue; // Skip hidden files
		}

		std::string fullPath=currentDir+name;
		struct stat st;
		if(stat(fullPath.c_str(),&st)!=0)
		{
			continue;
		}

		Entry e;
		e.name=name;
		e.isDir=S_ISDIR(st.st_mode);

		if(e.isDir)
		{
			dirs.push_back(e);
		}
		else if(MatchesExtension(name))
		{
			files.push_back(e);
		}
	}
	closedir(dir);

	// Sort directories and files alphabetically
	std::sort(dirs.begin(),dirs.end(),[](const Entry &a,const Entry &b){ return a.name<b.name; });
	std::sort(files.begin(),files.end(),[](const Entry &a,const Entry &b){ return a.name<b.name; });

	for(auto &d : dirs) entries.push_back(d);
	for(auto &f : files) entries.push_back(f);

	selectedIndex=0;
	scrollOffset=0;
}

void InProcessFileDialog::NavigateInto(int index)
{
	if(index<0||(int)entries.size()<=index)
	{
		return;
	}
	auto &e=entries[index];
	if(!e.isDir)
	{
		return;
	}

	if(e.name=="..")
	{
		NavigateUp();
		return;
	}

	currentDir+=e.name+"/";
	RefreshFileList();
}

void InProcessFileDialog::NavigateUp(void)
{
	if(currentDir.size()<=1)
	{
		return;
	}
	// Remove trailing slash
	auto pos=currentDir.rfind('/',currentDir.size()-2);
	if(pos!=std::string::npos)
	{
		currentDir=currentDir.substr(0,pos+1);
	}
	RefreshFileList();
}

void InProcessFileDialog::ConfirmSelection(void)
{
	if(selectedIndex<0||(int)entries.size()<=selectedIndex)
	{
		return;
	}
	auto &e=entries[selectedIndex];
	if(e.isDir)
	{
		NavigateInto(selectedIndex);
	}
	else
	{
		selectedPath=currentDir+e.name;
		Close();
	}
}

void InProcessFileDialog::EnsureSelectionVisible(void)
{
	if(selectedIndex<scrollOffset)
	{
		scrollOffset=selectedIndex;
	}
	// MaxVisibleItems needs winHei, but we use a rough estimate here
	// Actual clamping happens in Render
}

int InProcessFileDialog::MaxVisibleItems(int winHei) const
{
	int dlgH=winHei-2*DIALOG_MARGIN;
	int listH=dlgH-HEADER_HEIGHT-FOOTER_HEIGHT;
	return listH/ITEM_HEIGHT;
}

int InProcessFileDialog::DialogX0(int winWid) const { return DIALOG_MARGIN; }
int InProcessFileDialog::DialogY0(int /*winHei*/) const { return DIALOG_MARGIN; }
int InProcessFileDialog::DialogX1(int winWid) const { return winWid-DIALOG_MARGIN; }
int InProcessFileDialog::DialogY1(int winHei) const { return winHei-DIALOG_MARGIN; }
int InProcessFileDialog::ListY0(int winHei) const { return DialogY0(winHei)+HEADER_HEIGHT; }
int InProcessFileDialog::ListY1(int winHei) const { return DialogY1(winHei)-FOOTER_HEIGHT; }

// ---- Input ----

bool InProcessFileDialog::HandleMouseClick(int evt,int mx,int my,int winWid,int winHei)
{
	if(!active)
	{
		return false;
	}

	if(evt==FSMOUSEEVENT_LBUTTONDOWN)
	{
		int lx0=DialogX0(winWid)+8;
		int ly0=ListY0(winHei);
		int ly1=ListY1(winHei);

		if(mx>=DialogX0(winWid) && mx<DialogX1(winWid) && my>=ly0 && my<ly1)
		{
			int clickedItem=scrollOffset+(my-ly0)/ITEM_HEIGHT;
			if(clickedItem>=0 && clickedItem<(int)entries.size())
			{
				if(clickedItem==selectedIndex)
				{
					// Click on already selected item -> confirm
					ConfirmSelection();
				}
				else
				{
					selectedIndex=clickedItem;
				}
			}
		}
	}
	return true; // Always consume
}

bool InProcessFileDialog::HandleKey(int keyCode)
{
	if(!active)
	{
		return false;
	}

	switch(keyCode)
	{
	case FSKEY_ESC:
		selectedPath.clear();
		Close();
		break;
	case FSKEY_ENTER:
		ConfirmSelection();
		break;
	case FSKEY_UP:
		if(selectedIndex>0)
		{
			--selectedIndex;
			EnsureSelectionVisible();
		}
		break;
	case FSKEY_DOWN:
		if(selectedIndex<(int)entries.size()-1)
		{
			++selectedIndex;
			EnsureSelectionVisible();
		}
		break;
	case FSKEY_PAGEUP:
		selectedIndex-=10;
		if(selectedIndex<0) selectedIndex=0;
		EnsureSelectionVisible();
		break;
	case FSKEY_PAGEDOWN:
		selectedIndex+=10;
		if(selectedIndex>=(int)entries.size()) selectedIndex=(int)entries.size()-1;
		EnsureSelectionVisible();
		break;
	case FSKEY_BS:
		NavigateUp();
		break;
	}
	return true;
}

// ---- Rendering ----

void InProcessFileDialog::DrawRect(int x0,int y0,int x1,int y1,float r,float g,float b,float a) const
{
	glDisable(GL_TEXTURE_2D);
	glEnable(GL_BLEND);
	glBlendFunc(GL_SRC_ALPHA,GL_ONE_MINUS_SRC_ALPHA);
	glColor4f(r,g,b,a);
	glBegin(GL_QUADS);
	glVertex2i(x0,y0);
	glVertex2i(x1,y0);
	glVertex2i(x1,y1);
	glVertex2i(x0,y1);
	glEnd();
}

void InProcessFileDialog::DrawChar(int x,int y,char ch,float r,float g,float b) const
{
	if(ch<32||ch>127) ch='?';
	int idx=ch-32;
	int col=idx%ATLAS_COLS;
	int row=idx/ATLAS_COLS;

	float u0=(float)(col*8)/(float)ATLAS_W;
	float v0=(float)(row*16)/(float)ATLAS_H;
	float u1=(float)(col*8+8)/(float)ATLAS_W;
	float v1=(float)(row*16+16)/(float)ATLAS_H;

	glEnable(GL_TEXTURE_2D);
	glEnable(GL_BLEND);
	glBlendFunc(GL_SRC_ALPHA,GL_ONE_MINUS_SRC_ALPHA);
	glBindTexture(GL_TEXTURE_2D,fontTexId);
	glColor3f(r,g,b);

	glBegin(GL_QUADS);
	glTexCoord2f(u0,v0); glVertex2i(x,y);
	glTexCoord2f(u1,v0); glVertex2i(x+CHAR_W,y);
	glTexCoord2f(u1,v1); glVertex2i(x+CHAR_W,y+CHAR_H);
	glTexCoord2f(u0,v1); glVertex2i(x,y+CHAR_H);
	glEnd();
}

void InProcessFileDialog::DrawString(int x,int y,const char *str,float r,float g,float b) const
{
	while(*str)
	{
		DrawChar(x,y,*str,r,g,b);
		x+=CHAR_W;
		++str;
	}
}

void InProcessFileDialog::DrawStringClipped(int x,int y,const char *str,int maxW,float r,float g,float b) const
{
	int maxChars=maxW/CHAR_W;
	int len=(int)strlen(str);
	if(len<=maxChars)
	{
		DrawString(x,y,str,r,g,b);
	}
	else
	{
		// Truncate with "..."
		for(int i=0;i<maxChars-3 && str[i];++i)
		{
			DrawChar(x+i*CHAR_W,y,str[i],r,g,b);
		}
		DrawString(x+(maxChars-3)*CHAR_W,y,"...",r,g,b);
	}
}

void InProcessFileDialog::Render(int winWid,int winHei)
{
	if(!active||!fontInitialized)
	{
		return;
	}

	int x0=DialogX0(winWid);
	int y0=DialogY0(winHei);
	int x1=DialogX1(winWid);
	int y1=DialogY1(winHei);
	int ly0=ListY0(winHei);
	int ly1=ListY1(winHei);
	int maxVis=MaxVisibleItems(winHei);
	int contentW=x1-x0-16; // padding

	// Clamp scroll
	if(selectedIndex>=scrollOffset+maxVis)
	{
		scrollOffset=selectedIndex-maxVis+1;
	}
	if(selectedIndex<scrollOffset)
	{
		scrollOffset=selectedIndex;
	}
	if(scrollOffset<0)
	{
		scrollOffset=0;
	}

	// Background overlay (darken entire screen)
	DrawRect(0,0,winWid,winHei,0.0f,0.0f,0.0f,0.5f);

	// Dialog background
	DrawRect(x0,y0,x1,y1,0.1f,0.1f,0.15f,0.95f);

	// Header background
	DrawRect(x0,y0,x1,y0+HEADER_HEIGHT,0.15f,0.15f,0.25f,1.0f);

	// Title
	const char *title="Open File";
	switch(driveType)
	{
	case 0: title="Open CD Image"; break;
	case 1: title="Open FD0 Image"; break;
	case 2: title="Open FD1 Image"; break;
	}
	DrawString(x0+8,y0+4,title,1.0f,1.0f,1.0f);

	// Current path
	DrawStringClipped(x0+8,y0+22,currentDir.c_str(),contentW,0.6f,0.8f,1.0f);

	// File list
	for(int i=0;i<maxVis;++i)
	{
		int idx=scrollOffset+i;
		if(idx>=(int)entries.size())
		{
			break;
		}

		int iy=ly0+i*ITEM_HEIGHT;
		auto &e=entries[idx];

		// Selection highlight
		if(idx==selectedIndex)
		{
			DrawRect(x0+2,iy,x1-2,iy+ITEM_HEIGHT,0.2f,0.3f,0.6f,0.8f);
		}

		// Icon/prefix
		if(e.isDir)
		{
			DrawString(x0+8,iy+1,"[DIR]",0.8f,0.8f,0.4f);
			DrawStringClipped(x0+8+6*CHAR_W,iy+1,e.name.c_str(),contentW-6*CHAR_W,1.0f,1.0f,0.7f);
		}
		else
		{
			DrawString(x0+8,iy+1,"     ",0.7f,0.7f,0.7f);
			DrawStringClipped(x0+8+6*CHAR_W,iy+1,e.name.c_str(),contentW-6*CHAR_W,0.9f,0.9f,0.9f);
		}
	}

	// Scroll indicator
	if((int)entries.size()>maxVis)
	{
		int totalH=ly1-ly0;
		int thumbH=std::max(10,totalH*maxVis/(int)entries.size());
		int thumbY=ly0+scrollOffset*totalH/(int)entries.size();
		DrawRect(x1-6,ly0,x1-2,ly1,0.2f,0.2f,0.2f,0.5f);
		DrawRect(x1-6,thumbY,x1-2,thumbY+thumbH,0.5f,0.5f,0.6f,0.8f);
	}

	// Footer
	DrawRect(x0,y1-FOOTER_HEIGHT,x1,y1,0.15f,0.15f,0.25f,1.0f);
	DrawString(x0+8,y1-FOOTER_HEIGHT+4,"ESC:Cancel  Enter:Open  BS:Up",0.6f,0.6f,0.6f);

	// Restore OpenGL state
	glDisable(GL_BLEND);
	glEnable(GL_TEXTURE_2D);
	glColor3f(1,1,1);
}
